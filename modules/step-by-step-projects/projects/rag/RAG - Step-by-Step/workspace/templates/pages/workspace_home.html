{% extends "base.html" %}
{% block title %}Workspace{% endblock %}

{% block content %}
    <div class="flex h-screen bg-gray-100">

        <!-- üß± Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col justify-between">

            <!-- Bot√£o de voltar para Home -->
            <div class="p-4 border-b border-gray-700">
                <a href="{% url 'home' %}"
                   class="block bg-gray-800 hover:bg-gray-700 text-center py-2 rounded">
                    ‚Üê Voltar √† Home
                </a>
            </div>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-700">
                <a href="{% url 'logout' %}"
                   class="block text-center text-red-400 hover:text-red-300">
                   Sair
                </a>
            </div>

        </aside>

        <!-- üíº √Årea principal do Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">

            <!-- Header -->
            <header class="bg-white shadow px-6 py-4">
                <h1 class="text-2xl font-semibold text-gray-800">
                    Bem-vindo, {{ request.user.username }}!
                </h1>
            </header>

            <!-- üß≠ Breadcrumbs -->
            <nav class="text-sm text-gray-600 my-4 flex items-center space-x-2">

                {% if current_folder %}

                    {% if breadcrumbs|length > 1 %}
                        {% with prev_folder=breadcrumbs|slice:"-2:-1"|first %}
                            <a href="?folder={{ prev_folder.id }}" class="text-blue-600 hover:underline">‚Üê Voltar</a>
                        {% endwith %}
                    {% else %}
                        <a href="{% url 'workspace_home' %}" class="text-blue-600 hover:underline">‚Üê Voltar √† raiz</a>
                    {% endif %}

                    <span>/</span>

                    {% for folder in breadcrumbs %}
                        {% if not forloop.last %}
                            <a href="?folder={{ folder.id }}" class="hover:underline">{{ folder.name }}</a>
                            <span>/</span>
                        {% else %}
                            <span class="font-semibold">{{ folder.name }}</span>
                        {% endif %}
                    {% endfor %}

                {% else %}
                    <span class="text-gray-400 italic">üìÅ Raiz</span>
                {% endif %}
            </nav>

            <!-- Mensagens -->
            {% if messages %}
                <ul class="mb-4">
                    {% for message in messages %}
                        <li class="px-4 py-2 rounded 
                                {% if message.tags == 'success' %}bg-green-100 text-green-700
                                {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ message }}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            <!-- üìå Bot√µes -->
            <div class="mb-6">
                <button command="show-modal" commandfor="create_folder_modal"
                        class="inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    ‚ûï Nova Pasta
                </button>

                <form method="post" action="{% url 'upload_file' %}" enctype="multipart/form-data" class="inline-block">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="folder" value="{{ current_folder.id|default_if_none:'' }}">

                    <label class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded cursor-pointer">
                        üì§ Fazer Upload
                        <input type="file" name="file" multiple class="hidden" onchange="this.form.submit()">
                    </label>
                </form>
            </div>

            <!-- MODAL Criar Pasta -->
            <el-dialog>
                <dialog id="create_folder_modal" aria-labelledby="modal-title"
                        class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
                    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/50 transition-opacity"></el-dialog-backdrop>

                    <div tabindex="0" class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                        <el-dialog-panel class="relative transform rounded-lg bg-white shadow-xl transition-all sm:w-full sm:max-w-md p-6">
                            <form method="post" action="{% url 'create_folder' %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                <input type="hidden" name="parent" value="{{ current_folder.id|default_if_none:'' }}">

                                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-4">
                                    Criar nova pasta
                                </h3>

                                <div>
                                    <label for="nome_pasta" class="block text-sm font-medium text-gray-700">
                                        Nome da pasta
                                    </label>
                                    <input type="text" name="name" id="nome_pasta" required
                                        class="mt-1 block w-full px-4 py-2 border rounded-lg"
                                        autocomplete="off"
                                        value="{{ form.name.value|default:'' }}">

                                    {% if form.name.errors %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1">{{ form.name.errors.0 }}</p>
                                    {% else %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1 hidden"></p>
                                    {% endif %}
                                </div>

                                <div class="mt-6 flex justify-end space-x-2">

                                    <button type="submit" id="create_folder_btn"
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                                        Criar
                                    </button>

                                    <button type="button" command="close" commandfor="create_folder_modal"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </el-dialog-panel>
                    </div>
                </dialog>

                {% if show_modal %}
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            document.querySelector("#create_folder_modal").showModal();
                        });
                    </script>
                {% endif %}
            </el-dialog>

            <!-- üìÅ Listagem -->
            {% if folders or files %}
                <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">

                    <!-- Pastas -->
                    {% for folder in folders %}
                        <li class="bg-white border rounded-lg p-4 hover:shadow-md transition cursor-pointer">
                            <a href="?folder={{ folder.id }}" class="block">
                                <span class="text-gray-800 font-semibold flex items-center space-x-2">
                                    <span>üìÅ</span>
                                    <span>{{ folder.name }}</span>
                                </span>
                            </a>
                        </li>
                    {% endfor %}

                    <!-- Arquivos -->
                    {% for file in files %}
                        <li class="bg-white border rounded-lg p-4 hover:shadow-md transition">
                            <a href="{{ file.file.url }}" target="_blank" class="block">
                                <span class="text-gray-800 font-semibold flex items-center space-x-2">
                                    <span>üìÑ</span>
                                    <span>{{ file.name }}</span>
                                </span>
                                <p class="text-xs text-gray-500">
                                    Enviado em {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                    ({{ file.file.size|filesizeformat }})
                                </p>
                            </a>
                        </li>
                    {% endfor %}

                </ul>
            {% else %}
                <p class="pt-4 text-gray-500 italic">Nenhum item encontrado neste diret√≥rio.</p>
            {% endif %}

        </main>

    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const modal = document.querySelector("#create_folder_modal");
            const input = modal.querySelector("#nome_pasta");
            const serverError = document.getElementById("server-error");
            const cancelButtons = modal.querySelectorAll("button[command='close']");

            function clearModalFields() {
                input.value = "";
                serverError.textContent = "";
                serverError.classList.add("hidden");
            }

            cancelButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    clearModalFields();
                });
            });

            modal.addEventListener("cancel", function () {
                clearModalFields();
            });
        });
    </script>
{% endblock scripts %}
